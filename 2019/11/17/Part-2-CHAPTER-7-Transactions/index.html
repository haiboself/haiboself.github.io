<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Part 2: CHAPTER 7 Transactions | Hexo</title>
  <meta name="description" content="Reference http:&#x2F;&#x2F;www.zhai14.com&#x2F;blog&#x2F;strenghen-comprehension-on-dirty-read-and-phantom.html https:&#x2F;&#x2F;www.aneasystone.com&#x2F;archives&#x2F;2017&#x2F;10&#x2F;solving-dead-locks-one.html  Overview A transaction is a way fo">
<meta property="og:type" content="article">
<meta property="og:title" content="Part 2: CHAPTER 7 Transactions">
<meta property="og:url" content="http://example.com/2019/11/17/Part-2-CHAPTER-7-Transactions/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Reference http:&#x2F;&#x2F;www.zhai14.com&#x2F;blog&#x2F;strenghen-comprehension-on-dirty-read-and-phantom.html https:&#x2F;&#x2F;www.aneasystone.com&#x2F;archives&#x2F;2017&#x2F;10&#x2F;solving-dead-locks-one.html  Overview A transaction is a way fo">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-11-17T06:32:47.000Z">
<meta property="article:modified_time" content="2022-11-25T13:50:36.704Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="ddia">
<meta name="twitter:card" content="summary">
  <!-- Canonical links -->
  <link rel="canonical" href="http://example.com/2019/11/17/Part-2-CHAPTER-7-Transactions/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/haiboself" target="_blank">
          <img class="img-circle img-rotate" src="/images/curry.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">海博</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Fluent &amp; Low Latency</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Beijing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流分享~</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><span class="category-list-count">9</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/ddia/" style="font-size: 14px;">ddia</a> <a href="/tags/docker/" style="font-size: 13px;">docker</a> <a href="/tags/k8s/" style="font-size: 13px;">k8s</a> <a href="/tags/%E5%AE%B9%E5%99%A8/" style="font-size: 13px;">容器</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a>
              </p>
              <p class="item-title">
                <a href="/2022/10/30/yuque/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90kubernetes1-4%E7%AB%A0%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="title">深入剖析kubernetes 1-4章阅读总结</a>
              </p>
              <p class="item-date">
                <time datetime="2022-10-30T06:41:51.000Z" itemprop="datePublished">2022-10-30</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
              </p>
              <p class="item-title">
                <a href="/2019/12/12/Part-2-CHAPTER-9-Consistency-and-Consensus/" class="title">Part 2: CHAPTER 9 Consistency and Consensus</a>
              </p>
              <p class="item-date">
                <time datetime="2019-12-12T06:35:04.000Z" itemprop="datePublished">2019-12-12</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
              </p>
              <p class="item-title">
                <a href="/2019/11/26/Part-2-CHAPTER-8-The-Trouble-with-Distributed-Systems/" class="title">Part 2: CHAPTER 8 The Trouble with Distributed Systems</a>
              </p>
              <p class="item-date">
                <time datetime="2019-11-26T06:33:34.000Z" itemprop="datePublished">2019-11-26</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
              </p>
              <p class="item-title">
                <a href="/2019/11/17/Part-2-CHAPTER-7-Transactions/" class="title">Part 2: CHAPTER 7 Transactions</a>
              </p>
              <p class="item-date">
                <time datetime="2019-11-17T06:32:47.000Z" itemprop="datePublished">2019-11-17</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
              </p>
              <p class="item-title">
                <a href="/2019/10/27/Part-2-CHAPTER-6-Partitioning/" class="title">Part 2: CHAPTER 6 Partitioning</a>
              </p>
              <p class="item-date">
                <time datetime="2019-10-27T06:28:55.000Z" itemprop="datePublished">2019-10-27</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.</span> <span class="toc-text">Reference</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">2.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-Slippery-Concept-of-a-Transaction"><span class="toc-number">3.</span> <span class="toc-text">The Slippery Concept of a Transaction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#The-meaning-of-ACID"><span class="toc-number">3.1.</span> <span class="toc-text">The meaning of ACID</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Atomicity"><span class="toc-number">3.1.1.</span> <span class="toc-text">Atomicity</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Consistency"><span class="toc-number">3.1.2.</span> <span class="toc-text">Consistency</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Isolatoin-%E5%A4%84%E7%90%86-concurrency-problems"><span class="toc-number">3.1.3.</span> <span class="toc-text">Isolatoin(处理 concurrency problems)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Durability"><span class="toc-number">3.1.4.</span> <span class="toc-text">Durability</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Single-Object-and-Multi-Object-Operations"><span class="toc-number">3.2.</span> <span class="toc-text">Single-Object and Multi-Object Operations</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Weak-Isolation-Levels"><span class="toc-number">4.</span> <span class="toc-text">Weak Isolation Levels</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Read-Committed"><span class="toc-number">4.1.</span> <span class="toc-text">Read Committed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Snapshot-Isolation-and-Repeatable-Read"><span class="toc-number">4.2.</span> <span class="toc-text">Snapshot Isolation and Repeatable Read</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-multi-version-concurrency-control-MVCC"><span class="toc-number">4.2.1.</span> <span class="toc-text">实现: multi-version concurrency control (MVCC):</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Visibility-rules-for-observing-a-consistent-snapshot"><span class="toc-number">4.2.1.1.</span> <span class="toc-text">Visibility rules for observing a consistent snapshot</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Indexes-and-snapshot-isolation"><span class="toc-number">4.2.1.2.</span> <span class="toc-text">Indexes and snapshot isolation</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Preventing-Lost-Updates"><span class="toc-number">4.3.</span> <span class="toc-text">Preventing Lost Updates</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Atomic-write-operations"><span class="toc-number">4.3.0.1.</span> <span class="toc-text">Atomic write operations</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Explicit-locking"><span class="toc-number">4.3.1.</span> <span class="toc-text">Explicit locking</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Automatically-detecting-lost-updates"><span class="toc-number">4.3.1.1.</span> <span class="toc-text">Automatically detecting lost updates</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Compare-and-set"><span class="toc-number">4.3.1.2.</span> <span class="toc-text">Compare-and-set</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Write-Skew-and-Phantoms-%E5%B9%BB%E8%AF%BB"><span class="toc-number">4.4.</span> <span class="toc-text">Write Skew and Phantoms(幻读)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Serializability"><span class="toc-number">5.</span> <span class="toc-text">Serializability</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Actual-Serial-Execution"><span class="toc-number">5.1.</span> <span class="toc-text">Actual Serial Execution</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Encapsulating-transactions-in-stored-procedures"><span class="toc-number">5.1.1.</span> <span class="toc-text">Encapsulating transactions in stored procedures</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Two-Phase-Locking-2PL"><span class="toc-number">5.2.</span> <span class="toc-text">Two-Phase Locking(2PL)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Implementation"><span class="toc-number">5.2.0.1.</span> <span class="toc-text">Implementation</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Performance"><span class="toc-number">5.2.0.2.</span> <span class="toc-text">Performance</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Predicate-locks-%E8%B0%93%E8%AF%8D%E9%94%81"><span class="toc-number">5.2.0.3.</span> <span class="toc-text">Predicate locks(谓词锁)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Serializable-Snapshot-Isolation-SSI"><span class="toc-number">5.3.</span> <span class="toc-text">Serializable Snapshot Isolation(SSI)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Decisions-based-on-an-outdated-premise"><span class="toc-number">5.3.1.</span> <span class="toc-text">Decisions based on an outdated premise</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Performance-1"><span class="toc-number">5.3.2.</span> <span class="toc-text">Performance</span></a></li></ol></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Part-2-CHAPTER-7-Transactions" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Part 2: CHAPTER 7 Transactions
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2019/11/17/Part-2-CHAPTER-7-Transactions/" class="article-date">
	  <time datetime="2019-11-17T06:32:47.000Z" itemprop="datePublished">2019-11-17</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/ddia/" rel="tag">ddia</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2019/11/17/Part-2-CHAPTER-7-Transactions/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.zhai14.com/blog/strenghen-comprehension-on-dirty-read-and-phantom.html">http://www.zhai14.com/blog/strenghen-comprehension-on-dirty-read-and-phantom.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.aneasystone.com/archives/2017/10/solving-dead-locks-one.html">https://www.aneasystone.com/archives/2017/10/solving-dead-locks-one.html</a></li>
</ul>
<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><blockquote>
<p>A transaction is a way for an application to group several reads and writes together into a logical unit. Conceptually, all the reads and writes in a transaction are executed as one operation: <code>either the entire transaction succeeds (commit) or it fails (abort, rollback)</code></p>
</blockquote>
<blockquote>
<p>Transaction 简化了应用对数据库的访问,使 error handling 变得简单,因为无需考虑 partial failure。</p>
</blockquote>
<p>Widely used isolation levels(<code>解决数据库的并发读写问题</code>):</p>
<ul>
<li>read committed</li>
<li>snapshot isolation(repeatable read)</li>
<li>serialization</li>
</ul>
<p>Race conditions:</p>
<ul>
<li><p>Dirty reads: 一个 client 读取了另一个 client 尚未提交的写。</p>
</li>
<li><p>Dirty writes: 而当事务 A 更新时，事务 A 还没提交，事务 B 就也过来进行更新，覆盖了事务 A 提交的更新数据。Almost all transaction implementations prevent dirty writes.</p>
</li>
<li><p>Read skew(Repeatable Read): A client sees different parts of the database at different points in time。snapshot isolation level(MVCC) 可以防止 read skew。</p>
</li>
<li><p>Lost updates: read-modify-write cycle 下容易发生,snapshot isolation level 可以防止该问题。</p>
</li>
<li><p>Write skew: Only serializable isolation prevents this anomaly.</p>
</li>
<li><p>Phantom reads: Snapshot isolation prevents straightforward phantom reads, but phantoms in the context of write skew require special treatment, such as index-range locks.</p>
</li>
</ul>
<p>only serializable isolation protects against all of these issues. We discussed three different approaches to implementing serializable transactions:</p>
<ul>
<li><p>Literally executing transactions in a serial order: 如果您可以使每个事务的执行速度非常快，并且事务吞吐量足够低，可以在单个CPU核心上处理，那么这是一个简单而有效的选项。</p>
</li>
<li><p>Two-phase locking</p>
</li>
<li><p>Serializable snapshot isolation (SSI):It uses an optimistic approach, allowing transactions to proceed without blocking.</p>
</li>
</ul>
<h2 id="The-Slippery-Concept-of-a-Transaction"><a href="#The-Slippery-Concept-of-a-Transaction" class="headerlink" title="The Slippery Concept of a Transaction"></a>The Slippery Concept of a Transaction</h2><p>Nosql 牺牲一致性来保证可用性; Relation db 使用 transaction 来保证强一致性。说到底么有孰优孰劣,都是根据场景的 <code>trade-off</code>。</p>
<h3 id="The-meaning-of-ACID"><a href="#The-meaning-of-ACID" class="headerlink" title="The meaning of ACID"></a>The meaning of ACID</h3><h4 id="Atomicity"><a href="#Atomicity" class="headerlink" title="Atomicity"></a>Atomicity</h4><p>在 ACID 语境下, Atomicity 不是关于并发的原子性,而是: The ability to abort a transaction on error and have all writes from that transaction discarded is the defining feature of ACID atomicity.</p>
<h4 id="Consistency"><a href="#Consistency" class="headerlink" title="Consistency"></a>Consistency</h4><blockquote>
<p>this idea of consistency depends on the application’s notion of invariants, and it’s the application’s responsibility to define its transactions correctly so that they preserve consistency。</p>
</blockquote>
<p>指的是应用程序(不是数据库)需要保证数据读写保证其应用程序的约束条件,以保证一致性。</p>
<h4 id="Isolatoin-处理-concurrency-problems"><a href="#Isolatoin-处理-concurrency-problems" class="headerlink" title="Isolatoin(处理 concurrency problems)"></a>Isolatoin(处理 concurrency problems)</h4><p>Isolation in the sense of ACID means that concurrently executing transactions are isolated from each other: they cannot step on each other’s toes. </p>
<h4 id="Durability"><a href="#Durability" class="headerlink" title="Durability"></a>Durability</h4><p>Durability is the promise that once a transaction has committed successfully, any data it has written will not be forgotten, even if there is a hardware fault or the database crashes.</p>
<h3 id="Single-Object-and-Multi-Object-Operations"><a href="#Single-Object-and-Multi-Object-Operations" class="headerlink" title="Single-Object and Multi-Object Operations"></a>Single-Object and Multi-Object Operations</h3><p>To recap, in ACID, atomicity and isolation describe what the database should do if a client makes several writes within the same transaction.</p>
<ul>
<li>Single-object writes</li>
</ul>
<p>单条数据的读写也面临容错问题,比如当一条 10K 的 json 写入一半时网络断掉,所以对于 single-object, 存储也要提供 atomicity(可以用 log 实现) 和 isolation(可以用加锁的方式实现)。</p>
<ul>
<li>The need for multi-object transactions</li>
</ul>
<p>single-object 事物无法满足所有的场景,如更新数据的时候需同步更新二级索引,所以 multi-object transaction 是需要的。</p>
<ul>
<li>Handling errors and aborts</li>
</ul>
<p>Retrying an aborted transaction is a simple and effective error handling mechanism, 但是也会导致很多问题,比如不断重试对 server 造成压力。</p>
<h2 id="Weak-Isolation-Levels"><a href="#Weak-Isolation-Levels" class="headerlink" title="Weak Isolation Levels"></a>Weak Isolation Levels</h2><p>Serializable isolation means that the database guarantees that transactions have the same effect as if they ran serially (i.e., one at a time, without any concurrency)</p>
<p>但是 Serializable isolation has a performance cost, 所以 It’s therefore common for systems to use weaker levels of isolation, which protect against some concurrency issues, but not all。</p>
<h3 id="Read-Committed"><a href="#Read-Committed" class="headerlink" title="Read Committed"></a>Read Committed</h3><p><code>保证</code>:</p>
<ul>
<li>no dirty reads: 脏读会读取到不一致的数据</li>
<li>no dirty writes: usually by delaying the second write until the first write’s transaction has committed or aborted.</li>
</ul>
<p><code>实现</code>:<br>使用 row-level lock 实现,当一个 transaction 修改一个 object(row or document) 时,必须先获取这个 object 的锁直到 transaction 完成才释放。在 transaction 期间,其他 transaction 会读取到旧值。</p>
<h3 id="Snapshot-Isolation-and-Repeatable-Read"><a href="#Snapshot-Isolation-and-Repeatable-Read" class="headerlink" title="Snapshot Isolation and Repeatable Read"></a>Snapshot Isolation and Repeatable Read</h3><p>使用 Snapshot Isolation 来解决 repeatable read 的问题。</p>
<blockquote>
<p>The idea is that each transaction reads from <code>a consistent snapshot</code> of the database,Snapshot isolation is a boon for long-running, read-only queries such as backups and analytics.</p>
</blockquote>
<h4 id="实现-multi-version-concurrency-control-MVCC"><a href="#实现-multi-version-concurrency-control-MVCC" class="headerlink" title="实现: multi-version concurrency control (MVCC):"></a><code>实现</code>: <code>multi-version concurrency control (MVCC)</code>:</h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luchangyou/p/11321607.html">https://www.cnblogs.com/luchangyou/p/11321607.html</a></p>
</blockquote>
<ul>
<li>写: use write locks to prevent dirty writes</li>
<li>读: a key principle of snapshot isolation is readers never block writers, and writers never block readers。所以 the database must potentially keep several different committed versions of an object 来实现 snapshot 的效果。</li>
</ul>
<h5 id="Visibility-rules-for-observing-a-consistent-snapshot"><a href="#Visibility-rules-for-observing-a-consistent-snapshot" class="headerlink" title="Visibility rules for observing a consistent snapshot"></a>Visibility rules for observing a consistent snapshot</h5><p>Put another way, an object is visible if both of the following conditions are true:</p>
<ul>
<li>At the time when the reader’s transaction started, the transaction that created the object had already committed.</li>
<li>The object is not marked for deletion, or if it is, the transaction that requested deletion had not yet committed at the time when the reader’s transaction started.</li>
</ul>
<h5 id="Indexes-and-snapshot-isolation"><a href="#Indexes-and-snapshot-isolation" class="headerlink" title="Indexes and snapshot isolation"></a>Indexes and snapshot isolation</h5><ul>
<li><p>have the index simply point to all versions of an object and require an index query to filter out any object versions that are not visible to the current transaction</p>
</li>
<li><p>use an append-only&#x2F;copy-on-write variant that does not overwrite pages of the tree when they are updated, but instead creates a new copy of each modified page.</p>
</li>
<li><p>With append-only B-trees, every write transaction (or batch of transactions) creates a new B-tree root, and a particular root is a consistent snapshot of the database at the point in time when it was created.</p>
</li>
</ul>
<h3 id="Preventing-Lost-Updates"><a href="#Preventing-Lost-Updates" class="headerlink" title="Preventing Lost Updates"></a>Preventing Lost Updates</h3><h5 id="Atomic-write-operations"><a href="#Atomic-write-operations" class="headerlink" title="Atomic write operations"></a>Atomic write operations</h5><p><code>实现</code>:</p>
<ul>
<li>一种方法是使用排他锁,taking an exclusive lock on the object when it is read so that no other transaction can read it until the update has been applied.</li>
<li>一种方式是 simply force all atomic operations to be executed on a single thread.</li>
</ul>
<h4 id="Explicit-locking"><a href="#Explicit-locking" class="headerlink" title="Explicit locking"></a>Explicit locking</h4><p>如果 db 提供的 atomic write operations 不足, 就需要在应用层面提供锁机制来解决并发写带来的问题。</p>
<h5 id="Automatically-detecting-lost-updates"><a href="#Automatically-detecting-lost-updates" class="headerlink" title="Automatically detecting lost updates"></a>Automatically detecting lost updates</h5><p>An alternative is to allow them to execute in parallel and, if the transaction manager detects a lost update, abort the transaction and force it to retry its read-modify-write cycle.</p>
<p>An advantage of this approach is that databases can perform this check efficiently in conjunction with snapshot isolation. </p>
<h5 id="Compare-and-set"><a href="#Compare-and-set" class="headerlink" title="Compare-and-set"></a>Compare-and-set</h5><p>The purpose of this operation is to avoid lost updates by allowing an update to happen only if the value has not changed since you last read it。如:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- This may or may not be safe, depending on the database implementation</span></span><br><span class="line"><span class="keyword">UPDATE</span> wiki_pages <span class="keyword">SET</span> content <span class="operator">=</span> <span class="string">&#x27;new content&#x27;</span> <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1234</span> <span class="keyword">AND</span> content <span class="operator">=</span> <span class="string">&#x27;old content&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Write-Skew-and-Phantoms-幻读"><a href="#Write-Skew-and-Phantoms-幻读" class="headerlink" title="Write Skew and Phantoms(幻读)"></a>Write Skew and Phantoms(幻读)</h3><blockquote>
<p>This effect, where a write in one transaction changes the result of a search query in another transaction, is called a <code>phantom</code><br><code>Write skew</code> can occur if two transactions read the same objects, and then update some of those objects (different transactions may update different objects).</p>
</blockquote>
<p><strong>怎么解决?</strong></p>
<ul>
<li>use a serializable isolation level</li>
<li>probably to explicitly lock the rows that the transaction depends on</li>
<li>materializing conflicts: it takes a phantom and turns it into a lock conflict on a concrete set of rows that exist in the database。</li>
</ul>
<h2 id="Serializability"><a href="#Serializability" class="headerlink" title="Serializability"></a>Serializability</h2><blockquote>
<p>Serializable isolation: It guarantees that even though transactions may execute in parallel, the end result is the same as if they had executed one at a time, serially, without any concurrency</p>
</blockquote>
<p>3 种实现方式:</p>
<ul>
<li>Literally executing transactions in a serial order</li>
<li>Two-phase locking</li>
<li>Optimistic concurrency control techniques such as serializable snapshot isolation</li>
</ul>
<h3 id="Actual-Serial-Execution"><a href="#Actual-Serial-Execution" class="headerlink" title="Actual Serial Execution"></a>Actual Serial Execution</h3><h4 id="Encapsulating-transactions-in-stored-procedures"><a href="#Encapsulating-transactions-in-stored-procedures" class="headerlink" title="Encapsulating transactions in stored procedures"></a>Encapsulating transactions in stored procedures</h4><p>在使用 single-threaded serial transaction 的 db 中,db 和 client 进行交互式的事务非常的低效,所以一般 the application must submit the entire transaction code to the database ahead of time, as a <code>stored procedure</code>. </p>
<p><code>Serial execution 总结:</code></p>
<ul>
<li>Every transaction must be small and fast</li>
<li>It is limited to use cases where the active dataset can fit in memory·</li>
<li>Write throughput must be low enough to be handled on a single CPU core。</li>
<li>Cross-partition transactions are possible,但是很耗资源</li>
</ul>
<h3 id="Two-Phase-Locking-2PL"><a href="#Two-Phase-Locking-2PL" class="headerlink" title="Two-Phase Locking(2PL)"></a>Two-Phase Locking(2PL)</h3><p>In 2PL, writers don’t just block other writers; they also block readers and vice versa.</p>
<p>Two Phase:</p>
<ul>
<li>first phase: (while the transaction is executing) is when the locks are acquired</li>
<li>second phase: (at the end of the transaction) is when all the locks are released.</li>
</ul>
<h5 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h5><p>having a lock on each object in the database. The lock can either be in <code>shared mode</code> or in <code>exclusive mode</code>. 读取的时候获取共享锁,写的时候获取排他锁。可以允许同时多个读,但是读会阻塞写,写会阻塞其他读和写。</p>
<h5 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h5><p>For this reason, databases running 2PL can have quite unstable latencies, and they can be very slow at high percentiles if there is contention in the workload.</p>
<h5 id="Predicate-locks-谓词锁"><a href="#Predicate-locks-谓词锁" class="headerlink" title="Predicate locks(谓词锁)"></a>Predicate locks(谓词锁)</h5><p>The key idea here is that a predicate lock applies even to objects that do not yet exist in the database, but which might be added in the future (phantoms).</p>
<p>Index-range locks</p>
<h3 id="Serializable-Snapshot-Isolation-SSI"><a href="#Serializable-Snapshot-Isolation-SSI" class="headerlink" title="Serializable Snapshot Isolation(SSI)"></a>Serializable Snapshot Isolation(SSI)</h3><p>基于 snapshot isolation 技术, SSI adds an algorithm for <code>detecting</code> serialization conflicts among writes and determining which transactions to abort.</p>
<p>It provides full serializability, but has only a small performance penalty compared to snapshot isolation.</p>
<p>缺陷: 当有大量事务访问 the same objects,可能会导致大量的事务 abort。<br>优势: 当 contention between transactions is not too high 时,相比悲观并发技术会有更好的性能。而且  Like under snapshot isolation, writers don’t block readers, and vice versa。</p>
<h4 id="Decisions-based-on-an-outdated-premise"><a href="#Decisions-based-on-an-outdated-premise" class="headerlink" title="Decisions based on an outdated premise"></a>Decisions based on an outdated premise</h4><p>2 种 db 检测 query result might have changed 的方式:</p>
<p><strong>Detecting stale MVCC reads</strong>:<br>When the transaction wants to commit, the database checks whether any of the ignored writes have now been committed. If so, the transaction must be aborted.</p>
<p>By avoiding unnecessary aborts, SSI preserves snapshot isolation’s support for long-running reads from a consistent snapshot.</p>
<p><strong>Detecting writes that affect prior reads</strong>:<br>When a transaction writes to the database, it must look in the indexes for any other transactions that have recently read the affected data. it simply notifies the transactions that the data they read may no longer be up to date.</p>
<h4 id="Performance-1"><a href="#Performance-1" class="headerlink" title="Performance"></a>Performance</h4><p>The rate of aborts significantly affects the overall performance of SSI. </p>
<p>so SSI requires that read-write transactions be fairly short (long-running read-only transactions may be okay). However, SSI is probably less sensitive to slow transactions than two-phase locking or serial execution.</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="http://example.com/2019/11/17/Part-2-CHAPTER-7-Transactions/" title="Part 2: CHAPTER 7 Transactions" target="_blank" rel="external">http://example.com/2019/11/17/Part-2-CHAPTER-7-Transactions/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/haiboself" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/curry.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/haiboself" target="_blank"><span class="text-dark">海博</span><small class="ml-1x">Fluent &amp; Low Latency</small></a></h3>
        <div>大数据研发工程师</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2019/11/26/Part-2-CHAPTER-8-The-Trouble-with-Distributed-Systems/" title="Part 2: CHAPTER 8 The Trouble with Distributed Systems"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2019/10/27/Part-2-CHAPTER-6-Partitioning/" title="Part 2: CHAPTER 6 Partitioning"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: true,
    appId: 'GRcHYS3Jka5FNZsVBbtGprIk-gzGzoHsz',
    appKey: 'BOoClE3WSUbzE8xszYY308bu',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>