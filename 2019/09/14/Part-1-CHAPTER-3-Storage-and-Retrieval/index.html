<!DOCTYPE html>
<html lang=zh>
<head>
  <meta name="google-site-verification" content="NbhPDQgJdljFYVMvb8rRSB9zGMp0akcMvqQZJ3a4a0E" />
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Part 1: CHAPTER 3 Storage and Retrieval | Hexo</title>
  <meta name="description" content="? how databases arrange data on disk so that we can find it again efficiently? how we can store the data that we’re given(如何存储数据)? how we can find it again when we’re asked for it(如何检索数据)? storage eng">
<meta property="og:type" content="article">
<meta property="og:title" content="Part 1: CHAPTER 3 Storage and Retrieval">
<meta property="og:url" content="https://www.haiboself.cn/2019/09/14/Part-1-CHAPTER-3-Storage-and-Retrieval/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="? how databases arrange data on disk so that we can find it again efficiently? how we can store the data that we’re given(如何存储数据)? how we can find it again when we’re asked for it(如何检索数据)? storage eng">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://notes.shichao.io/dda/figure_3-1.png">
<meta property="og:image" content="https://miro.medium.com/max/4000/0*6zJnBf20REcr4Uet.png">
<meta property="og:image" content="https://panoply.io/uploads/versions/diagram4---x----750-328x---.jpg">
<meta property="og:image" content="https://i.ytimg.com/vi/KUwOcip7Zzc/maxresdefault.jpg">
<meta property="og:image" content="https://www.tutorialspoint.com/dwh/images/snowflake.jpg">
<meta property="og:image" content="https://blog-1314398479.cos.ap-nanjing.myqcloud.com/undefined/B9E87FFB-1A56-4A17-8EBF-E0B2A71D0322.png">
<meta property="article:published_time" content="2019-09-14T06:19:32.000Z">
<meta property="article:modified_time" content="2022-11-25T13:53:18.688Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="ddia">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://notes.shichao.io/dda/figure_3-1.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://www.haiboself.cn/2019/09/14/Part-1-CHAPTER-3-Storage-and-Retrieval/index.html">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
  
<meta name="generator" content="Hexo 6.3.0"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/haiboself" target="_blank">
          <img class="img-circle img-rotate" src="/images/curry.png" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">海博</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Fluent &amp; Low Latency</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Beijing, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流分享~</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/olap/">olap</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><span class="category-list-count">9</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/ddia/" style="font-size: 14px;">ddia</a> <a href="/tags/docker/" style="font-size: 13px;">docker</a> <a href="/tags/k8s/" style="font-size: 13px;">k8s</a> <a href="/tags/starrocks/" style="font-size: 13px;">starrocks</a> <a href="/tags/%E5%AE%B9%E5%99%A8/" style="font-size: 13px;">容器</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/06/">六月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/06/03/yuque/%E4%BD%BF%E7%94%A8Hdfs%20Hedged%20Read%E6%9C%BA%E5%88%B6%E8%A7%A3%E5%86%B3Hive%E5%A4%96%E8%A1%A8%E6%9F%A5%E8%AF%A2%E6%85%A2%E7%9A%84%E9%97%AE%E9%A2%98/" class="title">使用Hdfs Hedged Read机制解决Hive外表查询慢的问题</a>
              </p>
              <p class="item-date">
                <time datetime="2023-06-03T13:39:05.000Z" itemprop="datePublished">2023-06-03</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2023/03/25/yuque/StarRocks%20COMPACTION%20%E6%9C%BA%E5%88%B6%E8%A7%A3%E8%AF%BB1/" class="title">StarRocks COMPACTION 机制解读1</a>
              </p>
              <p class="item-date">
                <time datetime="2023-03-25T13:18:08.000Z" itemprop="datePublished">2023-03-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/olap/">olap</a>
              </p>
              <p class="item-title">
                <a href="/2022/12/04/2.2.9%E7%89%88%E6%9C%ACHive%E5%A4%96%E8%A1%A8%E5%85%83%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98%E5%88%B7%E6%96%B0%E5%8E%9F%E7%90%86/" class="title">StarRocks 2.2.9 Hive外表元数据缓存刷新原理</a>
              </p>
              <p class="item-date">
                <time datetime="2022-12-04T12:34:27.000Z" itemprop="datePublished">2022-12-04</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a>
              </p>
              <p class="item-title">
                <a href="/2022/10/30/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90kubernetes1-4%E7%AB%A0%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" class="title">深入剖析kubernetes 1-4章阅读总结</a>
              </p>
              <p class="item-date">
                <time datetime="2022-10-30T06:41:51.000Z" itemprop="datePublished">2022-10-30</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
              </p>
              <p class="item-title">
                <a href="/2019/12/12/Part-2-CHAPTER-9-Consistency-and-Consensus/" class="title">Part 2: CHAPTER 9 Consistency and Consensus</a>
              </p>
              <p class="item-date">
                <time datetime="2019-12-12T06:35:04.000Z" itemprop="datePublished">2019-12-12</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
  <aside class="sidebar sidebar-toc collapse   in  " id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OLTP-online-transaction-processing-Overview"><span class="toc-number">2.</span> <span class="toc-text">OLTP(online transaction processing) Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hash-Indexes-with-append-only"><span class="toc-number">2.1.</span> <span class="toc-text">Hash Indexes with append-only</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSTables-Sorted-String-Table-and-LSM-Trees"><span class="toc-number">2.2.</span> <span class="toc-text">SSTables(Sorted String Table) and LSM-Trees</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Constructing-and-maintaining-SSTables"><span class="toc-number">2.2.0.1.</span> <span class="toc-text">Constructing and maintaining SSTables</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#LSM-tree-Log-Structured-Merge-Tree"><span class="toc-number">2.2.0.2.</span> <span class="toc-text">LSM-tree(Log-Structured Merge-Tree)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Performance-optimizations"><span class="toc-number">2.2.1.</span> <span class="toc-text">Performance optimizations</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#B-Trees"><span class="toc-number">2.3.</span> <span class="toc-text">B-Trees</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Making-B-trees-reliable"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">Making B-trees reliable</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#B-tree-optimizations"><span class="toc-number">2.3.0.2.</span> <span class="toc-text">B-tree optimizations</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Comparing-B-Trees-and-LSM-Trees"><span class="toc-number">2.4.</span> <span class="toc-text">Comparing B-Trees and LSM-Trees</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Advantages-of-LSM-trees"><span class="toc-number">2.4.1.</span> <span class="toc-text">Advantages of LSM-trees</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Downsides-of-LSM-trees-%E5%86%99%E5%85%A5%E6%97%B6%E7%A9%BA%E9%97%B4%E6%8D%A2%E6%97%B6%E9%97%B4"><span class="toc-number">2.4.2.</span> <span class="toc-text">Downsides of LSM-trees:写入时空间换时间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Other-Indexing-Structures"><span class="toc-number">2.5.</span> <span class="toc-text">Other Indexing Structures</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Storing-values-within-the-index"><span class="toc-number">2.5.1.</span> <span class="toc-text">Storing values within the index</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Multi-column-indexes"><span class="toc-number">2.5.2.</span> <span class="toc-text">Multi-column indexes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Full-text-search-and-fuzzy-indexes"><span class="toc-number">2.5.3.</span> <span class="toc-text">Full-text search and fuzzy indexes</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Keeping-everything-in-memory"><span class="toc-number">2.5.4.</span> <span class="toc-text">Keeping everything in memory</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Summary"><span class="toc-number">2.6.</span> <span class="toc-text">Summary</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Log-structured-storage-engine"><span class="toc-number">2.6.1.</span> <span class="toc-text">Log-structured storage engine</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Page-orientated-storage-engine"><span class="toc-number">2.6.2.</span> <span class="toc-text">Page-orientated storage engine</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#else"><span class="toc-number">2.6.3.</span> <span class="toc-text">else</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OLAP-online-analytic-processing-Overview"><span class="toc-number">3.</span> <span class="toc-text">OLAP(online analytic processing ) Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-Warehousing"><span class="toc-number">3.1.</span> <span class="toc-text">Data Warehousing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stars-and-Snowflakes-Schemas-for-Analytics"><span class="toc-number">3.2.</span> <span class="toc-text">Stars and Snowflakes: Schemas for Analytics</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Column-Oriented-Storage"><span class="toc-number">3.3.</span> <span class="toc-text">Column-Oriented Storage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Column-Compression"><span class="toc-number">3.4.</span> <span class="toc-text">Column Compression</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sort-Order-in-Column-Storage"><span class="toc-number">3.5.</span> <span class="toc-text">Sort Order in Column Storage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Writing-to-Column-Oriented-Storage"><span class="toc-number">3.6.</span> <span class="toc-text">Writing to Column-Oriented Storage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Aggregation-Data-Cubes-and-Materialized-Views"><span class="toc-number">3.7.</span> <span class="toc-text">Aggregation: Data Cubes and Materialized Views</span></a></li></ol></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-Part-1-CHAPTER-3-Storage-and-Retrieval" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Part 1: CHAPTER 3 Storage and Retrieval
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2019/09/14/Part-1-CHAPTER-3-Storage-and-Retrieval/" class="article-date">
	  <time datetime="2019-09-14T06:19:32.000Z" itemprop="datePublished">2019-09-14</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link-link" href="/tags/ddia/" rel="tag">ddia</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2019/09/14/Part-1-CHAPTER-3-Storage-and-Retrieval/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h2 id=""><a href="#" class="headerlink" title="?"></a>?</h2><ol start="0">
<li>how databases arrange data on disk so that we can find it again efficiently?</li>
<li>how we can store the data that we’re given(如何存储数据)?</li>
<li>how we can find it again when we’re asked for it(如何检索数据)?</li>
<li>storage engine optimized for transactional(<code>OLTP</code>) 和 optimized for analytics(<code>OLAP</code>) 有何不同?</li>
<li>log-structured storage engines(如 <code>LSM-Trees</code>) and page-oriented storage enginers(如 <code>B-Trees</code>)?</li>
<li>index 的类型和原理?</li>
<li>内存中的结构是什么样, 磁盘的结构又是什么样? 如何从内存刷到磁盘, 又从磁盘恢复到内存?</li>
<li>data model, index, column-oriented, encoding 之间是如何配合的,它们之间的关系是什么</li>
</ol>
<h2 id="OLTP-online-transaction-processing-Overview"><a href="#OLTP-online-transaction-processing-Overview" class="headerlink" title="OLTP(online transaction processing) Overview"></a>OLTP(online transaction processing) Overview</h2><blockquote>
<p>A transaction needn’t necessarily have ACID (atomicity, consistency, isolation, and durability) properties. Transaction processing just means allowing clients to make low-latency reads and writes as opposed to batch processing jobs, which only run periodically (for example, once per day). </p>
</blockquote>
<p><code>Storage:</code> 相比随机写入顺序写入简单高效, 因此 Many databases internally use a log(an append-only sequence of records), which is an <code>append-only</code>(the simplest possible write operation) data file.</p>
<p><code>Retrieval:</code> TP 应用通常面向用户,使用 key 检索数据,结果集也通常较小,对响应时间有要求,因此 store engine 使用 index 来加速查询。Disk seek time is often the bottleneck here.</p>
<blockquote>
<p><code>Index:</code> Index 利用额外的存储(来自 data)来加速查询. 维持 index 会面临一些成本,尤其是当写入时,需要同步更新 index。由于 index 可以加速查询, 降低写入效率,所以索引的建立需开发人员去权衡.</p>
</blockquote>
<h3 id="Hash-Indexes-with-append-only"><a href="#Hash-Indexes-with-append-only" class="headerlink" title="Hash Indexes with append-only"></a>Hash Indexes with append-only</h3><p><code>Storage:</code> 数据以 (k,v) pair 的形式存储在磁盘,以 append only 的方式进行追加<br><code>Retrieval:</code> 在内存中维护 hash index,数据追加时同步更新 index</p>
<p><img src="https://notes.shichao.io/dda/figure_3-1.png" alt="image"></p>
<p><strong>以 append-only 方式追加会导致磁盘空间不足,为了解决这个问题:</strong></p>
<ol>
<li>将 log 切分为定长的 segment, 当 segment file 到达固定大小时,后续的 log 写入新的 segment file</li>
<li>定期对 segment file 进行 compaction(throwing away duplicate keys in the log, and keeping only the most recent update for each key),也可以将多个 segment file compaction 为一个</li>
<li>segment file 是只读的, compaction 会产生新的文件.在 compaction 的同时, old segment file 仍可以提供读写服务.当 compaction 完成时,使用新的 segment file, 删除老的 segment file。</li>
</ol>
<p><strong>这个方案一些要关注的点:</strong></p>
<ul>
<li>File format: use a binary format that first encodes the length of a string in bytes, followed by the raw string</li>
<li>Deleting records: use a binary format that first encodes the length of a string in bytes, followed by the raw string. merge 的时候会删除数据.</li>
<li><code>Crash recovery</code>: Bitcask speeds up recovery by storing a snapshot of each segment’s hash map on disk, which can be loaded into memory more quickly.</li>
<li><code>Partially written records</code>: include checksums, allowing such corrupted parts of the log to be detected and ignored.</li>
<li><code>Concurrency control</code>: 单线程写入,一个 file 要么是 append-only 要么是 immutable, 所以可以多线程读取</li>
</ul>
<p><strong>优势:</strong></p>
<ul>
<li>append 和 segment merge 是顺序写入操作,比随机写入要高效</li>
<li>Concurrency and crash recovery are much simpler if segment files are append-only or immutable</li>
<li>Merging old segments avoids the problem of data files getting fragmented over time.</li>
</ul>
<p><strong>Limitations:</strong></p>
<ul>
<li>The hash table must fit in memory,当 hash table 很<br>大被迫放入磁盘时,索引效率就会下降,还会面临 hash 冲突的问题.</li>
<li>Range queries are not efficient.</li>
</ul>
<h3 id="SSTables-Sorted-String-Table-and-LSM-Trees"><a href="#SSTables-Sorted-String-Table-and-LSM-Trees" class="headerlink" title="SSTables(Sorted String Table) and LSM-Trees"></a>SSTables(Sorted String Table) and LSM-Trees</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.open-open.com/lib/view/open1424916275249.html">https://www.open-open.com/lib/view/open1424916275249.html</a><br><a target="_blank" rel="noopener" href="https://ggaaooppeenngg.github.io/zh-CN/2017/03/31/%E4%BB%8E%E6%9C%B4%E7%B4%A0%E8%A7%A3%E9%87%8A%E5%87%BA%E5%8F%91%E8%A7%A3%E9%87%8Aleveldb%E7%9A%84%E8%AE%BE%E8%AE%A1/">https://ggaaooppeenngg.github.io/zh-CN/2017/03/31/%E4%BB%8E%E6%9C%B4%E7%B4%A0%E8%A7%A3%E9%87%8A%E5%87%BA%E5%8F%91%E8%A7%A3%E9%87%8Aleveldb%E7%9A%84%E8%AE%BE%E8%AE%A1/</a></p>
</blockquote>
<p>如何使用 SSTables 来解决 hash index 的问题呢</p>
<p><code>Storage:</code> 在 hash index 中 k,v 数据按照写入顺序存储,且同一个 k 会存在多个 segment file 中。在 SSTable 中, we require that the sequence of key-value pairs is <code>sorted by key</code>.We also require that each key <code>only appears once </code> within each merged segment file</p>
<p><code>Retrieval:</code> 因为 key 按序存储,所以 index 中的一个 key 可以表示一个范围的上&#x2F;下界,找到数据所在范围后再 scan 者个范围内的数据。先检索内存中的 memtable, 再根据时间检索磁盘上的 SSTables.</p>
<p><img src="https://miro.medium.com/max/4000/0*6zJnBf20REcr4Uet.png" alt="img"></p>
<p><strong>Advantages:</strong></p>
<ul>
<li>Merging segments is simple and efficient, even if the files are bigger than the available memory, 类似于合并有序数组</li>
<li>you no longer need to keep an index of all the keys in memory. 因为有序, hash table 中的一个 key 可以代表一个范围的上&#x2F;下界,通过 scan 这个小范围来检索数据</li>
<li>it is possible to <code>group those records into a block and compress it</code> before writing it to disk. 这可以节省磁盘同时也能降低 IO 带宽</li>
</ul>
<h5 id="Constructing-and-maintaining-SSTables"><a href="#Constructing-and-maintaining-SSTables" class="headerlink" title="Constructing and maintaining SSTables"></a>Constructing and maintaining SSTables</h5><p>Sorted structure on disk: LSM-tree(Log-Structured Merge-Tree)?<br>Sorted structure in memory: red-black trees or AVL trees</p>
<p><strong>Work flow:</strong></p>
<ol>
<li>add write to and in-memory balanced tree structure called <code>memtable</code></li>
<li>When the memtable gets bigger than some threshold—typically a few megabytes—write it out to <code>disk as an SSTable file</code>.</li>
<li>In order to serve a read request, first try to find the key in the memtable, then in the most recent on-disk segment, then in the next-older segment, etc.</li>
<li>From time to time, run a merging and compaction process in the background to combine segment files and to discard overwritten or deleted values.</li>
</ol>
<p><code>唯一的问题:</code> 当 database crashed, 还没刷到磁盘的 memetable 就会丢失,为了避免这个问题,写一条数据时,同时以简单的 append 方式追加到一个 log 中,便于 crash 后 memtable 的恢复</p>
<h5 id="LSM-tree-Log-Structured-Merge-Tree"><a href="#LSM-tree-Log-Structured-Merge-Tree" class="headerlink" title="LSM-tree(Log-Structured Merge-Tree)"></a>LSM-tree(Log-Structured Merge-Tree)</h5><p><code>写快读慢,因为顺序写入,读取的时候需要检索 memtable 和 sstable.</code></p>
<p>Storage engines that are based on this principle of merging and compacting sorted files are often called LSM storage engines.</p>
<p>the basic idea of LSM-trees—keeping a cascade of SSTables that are merged in the background is simple and effective</p>
<p>由于数据存储有序,所以 index 可以进行 range query,这保证了再大数据集下不错的检索性能。<br>由于顺序写入, LSM-tree 也可以支持大的写吞吐;</p>
<p>Reads are typically slower on LSM-trees because they have to check several different data structures and SSTables at different stages of compaction.</p>
<h4 id="Performance-optimizations"><a href="#Performance-optimizations" class="headerlink" title="Performance optimizations"></a>Performance optimizations</h4><ul>
<li>检索一个不存在的 key 费时费力,为了解决这个问题,常使用额外的 bloom-filter</li>
</ul>
<p><strong>Merge 和 compact 方式:</strong></p>
<ul>
<li><p>size-tiered: newer and smaller SSTables are successively merged into older and larger SSTables.</p>
</li>
<li><p>leveled compaction: the key range is split up into smaller SSTables and older data is moved into separate “levels,” which allows the compaction to proceed more incrementally and use less disk space</p>
</li>
</ul>
<h3 id="B-Trees"><a href="#B-Trees" class="headerlink" title="B-Trees"></a>B-Trees</h3><p><code>Storage:</code> (k,v) 按 k 有序存储,which allows efficient key-value lookups and range queries。B-trees break the database down into <code>fixed-size blocks or pages</code>, traditionally 4 KB in size (sometimes bigger), and read or write one page at a time. This design corresponds more closely to the underlying hardware, as disks are also arranged in fixed-size blocks.</p>
<blockquote>
<p>Most databases can fit into a B-tree that is three or four levels deep, so you don’t need to follow many page references to find the page you are look‐ing for. (A four-level tree of 4 KB pages with a branching factor of 500 can store up to 256 TB.)</p>
</blockquote>
<h5 id="Making-B-trees-reliable"><a href="#Making-B-trees-reliable" class="headerlink" title="Making B-trees reliable"></a>Making B-trees reliable</h5><p>B-tree is to overwrite a page on disk with new data. It is assumed that the overwrite does not change the location of the page;</p>
<ul>
<li><p><strong>fault-tolerant when database crash?</strong><br>In order to make the database resilient to crashes, it is common for B-tree implementations to include an additional data structure on disk: a <code>write-ahead log</code> (WAL, also known as a redo log).</p>
</li>
<li><p><code>并发问题:</code> This is typically done by protecting the tree’s data structures with latches (lightweight locks).</p>
</li>
</ul>
<h5 id="B-tree-optimizations"><a href="#B-tree-optimizations" class="headerlink" title="B-tree optimizations"></a>B-tree optimizations</h5><ul>
<li>copy-on-write</li>
<li>……</li>
</ul>
<h3 id="Comparing-B-Trees-and-LSM-Trees"><a href="#Comparing-B-Trees-and-LSM-Trees" class="headerlink" title="Comparing B-Trees and LSM-Trees"></a>Comparing B-Trees and LSM-Trees</h3><p>B-tree: 写慢读快;每条数据只存在于一个地方,所以可以支持强大的事务能力<br>Lsm-tree: 写快读慢,同一个 key 可能在不同的 segment 中</p>
<h4 id="Advantages-of-LSM-trees"><a href="#Advantages-of-LSM-trees" class="headerlink" title="Advantages of LSM-trees"></a>Advantages of LSM-trees</h4><p><code>相比于 B-trees, LSM-trees 可以维持 higher write throughput:</code></p>
<ol>
<li>lsm-trees have lower write amplification</li>
<li>sequentially write compact SSTable</li>
</ol>
<p><code>LSM-trees 磁盘利用率相对较高</code>: LSM-trees can be compressed better, and thus often produce smaller files on disk than B-trees.</p>
<blockquote>
<p>write amplification(写放大):</p>
<ul>
<li>A B-tree index must write every piece of data at least twice: index 和 数据</li>
<li>Log-structured indexes also rewrite data multiple times due to repeated compaction and merging of SSTables</li>
</ul>
</blockquote>
<h4 id="Downsides-of-LSM-trees-写入时空间换时间"><a href="#Downsides-of-LSM-trees-写入时空间换时间" class="headerlink" title="Downsides of LSM-trees:写入时空间换时间"></a>Downsides of LSM-trees:写入时空间换时间</h4><ol>
<li><p>compaction process 有时和 ongoing reads and writes process 会互相干扰</p>
</li>
<li><p>Another issue with compaction arises at high write throughput: the disk’s finite write bandwidth needs to be shared between the initial write (logging and flushing a memtable to disk) and the compaction threads running in the background.</p>
</li>
</ol>
<h3 id="Other-Indexing-Structures"><a href="#Other-Indexing-Structures" class="headerlink" title="Other Indexing Structures"></a>Other Indexing Structures</h3><p>二级索引</p>
<h4 id="Storing-values-within-the-index"><a href="#Storing-values-within-the-index" class="headerlink" title="Storing values within the index"></a>Storing values within the index</h4><p>数据存储在 heap file 中,索引处存储 heap file 的 reference,这样可以避免重复存储数据.index 中新值可以 overwrite 老值, index 无需更新; 如果空间不够需要生成新的 heapfile, 则需要更新 index。</p>
<p><code>clustered index(storing all row data within the index):</code> so it can be desirable to store the indexed row directly within an index. This is known as a clustered index(<code>聚集索引,比如 mysql 主键</code>).</p>
<p><code>covering index:(比如 mysql 主键外其他键上索引)</code> which stores some of a table’s columns within the index </p>
<h4 id="Multi-column-indexes"><a href="#Multi-column-indexes" class="headerlink" title="Multi-column indexes"></a>Multi-column indexes</h4><p><code>concatenated index(比如 mysql 联合唯一键):</code> simply combines several fields into one key by appending one column to another (the index definition specifies in which order the fields are concatenated)</p>
<p>Multi-dimensional indexes are a more general way of querying several columns at once, 比如 R 树?</p>
<h4 id="Full-text-search-and-fuzzy-indexes"><a href="#Full-text-search-and-fuzzy-indexes" class="headerlink" title="Full-text search and fuzzy indexes"></a>Full-text search and fuzzy indexes</h4><p>To cope with typos in documents or queries, Lucene is able to search text for words within a certain edit distance</p>
<p>but in Lucene, the in-memory index is a finite state automaton over the characters in the keys, similar to a trie </p>
<h4 id="Keeping-everything-in-memory"><a href="#Keeping-everything-in-memory" class="headerlink" title="Keeping everything in memory"></a>Keeping everything in memory</h4><p>But other in-memory databases aim for durability, which can be achieved with special hardware (such as battery-powered RAM), by writing a log of changes to disk, by writing periodic snapshots to disk, or by replicating the in-memory state to other machines.</p>
<p><strong>Counterintuitively, the performance advantage of in-memory databases is not due to the fact that they don’t need to read from disk.Rather, they can be faster because they can avoid the overheads of encoding in-memory data structures in a form that can be written to disk</strong></p>
<p>Besides performance, another interesting area for in-memory databases is providing data models that are difficult to implement with disk-based indexes. </p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><h4 id="Log-structured-storage-engine"><a href="#Log-structured-storage-engine" class="headerlink" title="Log-structured storage engine"></a>Log-structured storage engine</h4><p>Hash Index + append only</p>
<ul>
<li>log 分为 segments, 后台 merge 和 compaction, 磁盘利用率低</li>
<li>index 受内存大小限制</li>
<li>难以进行 range query</li>
</ul>
<p>Range Index + SSTable(LSM-Trees 是其进阶)</p>
<ul>
<li>写入按 k 排序, 写入 mmtable(memory), 写满后刷到 SSTable(disk)</li>
<li>range index + scan filter, 不受内存限制, range query 支持良好</li>
<li>后台进行 merge(高效的有序合并) 和 compaction; 磁盘利用率高</li>
<li>相对读慢写快(顺序写入,append-only,不 update,合并时 delete)</li>
<li>crash recovery: append-only log</li>
<li>并发问题: 以上 2 个都是单线程写入, segment file 不可变,可以多线程读取;</li>
</ul>
<p>Their key idea is that they systematically <code>turn random-access writes into sequential writes on disk</code>, which enables higher write throughput due to the performance characteristics of hard drives and SSDs.</p>
<h4 id="Page-orientated-storage-engine"><a href="#Page-orientated-storage-engine" class="headerlink" title="Page-orientated storage engine"></a>Page-orientated storage engine</h4><p>B-Trees(update-in-place)</p>
<ul>
<li>按 k 排序,会进行 update(overwrite)</li>
<li>数据只有一份,事务支持强大</li>
<li>读快写慢(随机写入,还有可能 B 树要分裂)</li>
<li>crash recovery: write-ahead log</li>
<li>concurrency issue: latches (lightweight locks)</li>
<li>二级索引,聚集索引,非聚集索引…</li>
<li>Multi-column indexes</li>
</ul>
<h4 id="else"><a href="#else" class="headerlink" title="else"></a>else</h4><ul>
<li>全文索引</li>
<li>模糊索引</li>
<li>Keeping everything in memory</li>
</ul>
<h2 id="OLAP-online-analytic-processing-Overview"><a href="#OLAP-online-analytic-processing-Overview" class="headerlink" title="OLAP(online analytic processing ) Overview"></a>OLAP(online analytic processing ) Overview</h2><p>特点: scan 大量的数据, project 一些字段,在这些数据上进行聚合运算</p>
<p>Instead it becomes important to encode data very compactly, <code>to minimize the amount of data that the query needs to read from disk.</code> We discussed how column-oriented storage helps achieve this goal.</p>
<h3 id="Data-Warehousing"><a href="#Data-Warehousing" class="headerlink" title="Data Warehousing"></a>Data Warehousing</h3><p>通过 ETL 将 TP 系统中的数据以合适的方式收集到 data warehouse 中进行 AP 分析.DW 通常是关系模型,因此使用 sql 分析非常合适。</p>
<blockquote>
<p>A data warehouse, by contrast, is a separate database that analysts can query to their hearts’ content, without affecting OLTP operations</p>
</blockquote>
<p>A big advantage of using a separate data warehouse, rather than querying OLTP systems directly for analytics, is that the data warehouse can be optimized for analytic access patterns.</p>
<p><img src="https://panoply.io/uploads/versions/diagram4---x----750-328x---.jpg" alt="img"></p>
<h3 id="Stars-and-Snowflakes-Schemas-for-Analytics"><a href="#Stars-and-Snowflakes-Schemas-for-Analytics" class="headerlink" title="Stars and Snowflakes: Schemas for Analytics"></a>Stars and Snowflakes: Schemas for Analytics</h3><p><code>Stars schema(也称维度建模):</code> 中间是事实表,其通常包含很多字段,有些是属性,有些事指向维度表的外键。</p>
<p><img src="https://i.ytimg.com/vi/KUwOcip7Zzc/maxresdefault.jpg" alt="img"></p>
<p><code>Snowflakes schema:</code> 是 Stars 的变体,维度表维度和以被细分为更小的维度</p>
<p><img src="https://www.tutorialspoint.com/dwh/images/snowflake.jpg" alt="img"></p>
<blockquote>
<p>fact table(事实表): Each row of the fact table represents an event that occurred at a particular time<br>dimension table(维度表): the dimensions represent the who, what, where, when, how, and why of the event</p>
</blockquote>
<h3 id="Column-Oriented-Storage"><a href="#Column-Oriented-Storage" class="headerlink" title="Column-Oriented Storage"></a>Column-Oriented Storage</h3><p>row-oriented storage 对事务支持更好, column-oriented storage 对分析支持更好.</p>
<p>The idea behind column-oriented storage is simple: don’t store all the values from one row together, but store all the values from each column together instead.</p>
<p>The column-oriented storage layout relies on each column file containing the rows in the same order.</p>
<h3 id="Column-Compression"><a href="#Column-Compression" class="headerlink" title="Column Compression"></a>Column Compression</h3><p>we can further reduce the demands on disk throughput by compressing data</p>
<blockquote>
<p>bitmap encoding<br>vectorized processing </p>
</blockquote>
<p>A big bottleneck is the bandwidth for getting data from disk into memory</p>
<p>Developers of analytical databases also worry about efficiently using the bandwidth from main memory into the CPU cache</p>
<h3 id="Sort-Order-in-Column-Storage"><a href="#Sort-Order-in-Column-Storage" class="headerlink" title="Sort Order in Column Storage"></a>Sort Order in Column Storage</h3><p>在列存中顺序无关紧要,存储按照 insert 顺序来就好了.但是仍然可以类似 SSTable 指定顺序用来实现索引:</p>
<p>Rather, the data needs to be sorted an entire row at a time, even though it is stored by column.</p>
<p>A second column can determine the sort order of any rows that have the same value in the first column. </p>
<p>Another advantage of sorted order is that it can help with compression of columns</p>
<p><code>Having multiple sort orders in a column-oriented store is a bit similar to having mul‐ tiple secondary indexes in a row-oriented store.</code></p>
<h3 id="Writing-to-Column-Oriented-Storage"><a href="#Writing-to-Column-Oriented-Storage" class="headerlink" title="Writing to Column-Oriented Storage"></a>Writing to Column-Oriented Storage</h3><p>面向列,压缩和排序增加了写入成本。可以使用类似 LSM-trees 的方式,将数据写入 memtable 再刷到磁盘,刷到磁盘的时候生成 column-oriented 文件。只是这样以来,查询就需要合并 memtable 和磁盘文件,但是查询优化器会对用户屏蔽这些底层细节。</p>
<h3 id="Aggregation-Data-Cubes-and-Materialized-Views"><a href="#Aggregation-Data-Cubes-and-Materialized-Views" class="headerlink" title="Aggregation: Data Cubes and Materialized Views"></a>Aggregation: Data Cubes and Materialized Views</h3><p><code>Materialized view:</code> is and actual copy of the query results, written to disk,When the underlying data changes, a materialized view needs to be updated</p>
<p>A common special case of a materialized view is known as a data cube or OLAP cube, It is a grid of aggregates grouped by different dimensions.</p>
<p>The disadvantage is that a data cube doesn’t have the same flexibility as querying the raw data</p>
<p><img src="https://blog-1314398479.cos.ap-nanjing.myqcloud.com/undefined/B9E87FFB-1A56-4A17-8EBF-E0B2A71D0322.png"></p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://www.haiboself.cn/2019/09/14/Part-1-CHAPTER-3-Storage-and-Retrieval/" title="Part 1: CHAPTER 3 Storage and Retrieval" target="_blank" rel="external">https://www.haiboself.cn/2019/09/14/Part-1-CHAPTER-3-Storage-and-Retrieval/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/haiboself" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/curry.png" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/haiboself" target="_blank"><span class="text-dark">海博</span><small class="ml-1x">Fluent &amp; Low Latency</small></a></h3>
        <div>大数据研发工程师</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
      <div id="vcomments"></div>
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2019/09/15/Part-1-CHAPTER-4-Encoding-and-Evolution/" title="Part 1: CHAPTER 4 Encoding and Evolution"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2019/09/08/Part-1-CHAPTER-2-Data-Models-and-Query-Languages/" title="Part 1: CHAPTER 2 Data Models and Query Languages"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn " data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">    <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  <!-- Button trigger modal -->
  <button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button>
  <!-- <div class="wave-icon wave-icon-danger btn-donate" data-toggle="modal" data-target="#donateModal">
    <div class="wave-circle"><span class="icon"><i class="icon icon-bill"></i></span></div>
  </div> -->
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  
<!-- Modal -->
<div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content donate">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <div class="modal-body">
        <div class="donate-box">
          <div class="donate-head">
            <p>感谢您的支持，我会继续努力的!</p>
          </div>
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane fade active in" id="alipay">
              <div class="donate-payimg">
                <img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p>
            </div>
            <div role="tabpanel" class="tab-pane fade" id="wechatpay">
              <div class="donate-payimg">
                <img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫" />
              </div>
              <p class="text-muted mv">扫码打赏，你说多少就多少</p>
              <p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p>
            </div>
          </div>
          <div class="donate-footer">
            <ul class="nav nav-tabs nav-justified" role="tablist">
              <li role="presentation" class="active">
                <a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a>
              </li>
              <li role="presentation" class="">
                <a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/valine"></script>
  <script type="text/javascript">
  var GUEST = ['nick', 'mail', 'link'];
  var meta = 'nick,mail,link';
  meta = meta.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#vcomments',
    verify: false,
    notify: true,
    appId: 'GRcHYS3Jka5FNZsVBbtGprIk-gzGzoHsz',
    appKey: 'BOoClE3WSUbzE8xszYY308bu',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: meta,
    pageSize: '10' || 10,
    visitor: false
  });
  </script>

     







</body>
</html>